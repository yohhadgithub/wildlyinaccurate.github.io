<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width,initial-scale=1"> <title>Blazing fast WordPress with Nginx and Memcached | Wildly Inaccurate</title> <meta name="description" content="Inspired by Eric Mann’s post on caching WordPress with Redis, I thought I’d experiment with a similar setup using Memcached. Any in-memory caching system should work just as well, but I’ve chosen Memcached because it’s already running on my server..."> <link rel="stylesheet" href="/css/main.9024546.css"> <link rel="canonical" href="https://wildlyinaccurate.com/blazing-fast-wordpress-with-nginx-and-memcached"> <link rel="alternate" type="application/atom+xml" title="Wildly Inaccurate" href="https://wildlyinaccurate.com/feed.xml"> </head> <body> <nav class="navbar"> <div class="container"> <a href="https://wildlyinaccurate.com" class="navbar__title navbar__link">Wildly Inaccurate</a> <ul class="navbar-nav"> <li class="navbar-nav__item"> <a class="navbar-nav__item-link navbar__link" href="/about/">About</a> </li> <li class="navbar-nav__item"> <a class="navbar-nav__item-link navbar__link" href="/projects/">Projects</a> </li> </ul> </div> </nav> <header class="page-header"> <img class="page-header__featured-image" src="/assets/default-featured-image.jpg" srcset="/assets/resized/default-featured-image-290x121.jpg 290w, /assets/resized/default-featured-image-315x132.jpg 315w, /assets/resized/default-featured-image-720x301.jpg 720w, /assets/resized/default-featured-image-940x393.jpg 940w, /assets/resized/default-featured-image-780x326.jpg 780w, /assets/resized/default-featured-image-1280x535.jpg 1280w, /assets/resized/default-featured-image-1360x568.jpg 1360w, /assets/resized/default-featured-image-1680x702.jpg 1680w, /assets/resized/default-featured-image-1840x769.jpg 1840w,  /assets/default-featured-image.jpg 2600w"> <div class="container"> <h1 class="page-header__title">Blazing fast WordPress with Nginx and Memcached</h1> <p class="post-meta--header"> May 20, 2013 • by Joseph Wynn • posted in <span class="post-meta__data"> [<a href="/category/server administration/">server administration</a>, <a href="/category/web development/">web development</a>] </span> </p> </div> </header> <article class="post-content"> <p>Inspired by Eric Mann’s post on <a href="http://eamann.com/tech/ludicrous-speed-wordpress-caching-with-redis/">caching WordPress with Redis</a>, I thought I’d experiment with a similar setup using Memcached. Any in-memory caching system should work just as well, but I’ve chosen Memcached because it’s already running on my server and because PHP already has a <a href="http://www.php.net/manual/en/class.memcached.php">built-in libmemcached API</a>.</p> <p>My current setup is Nginx and PHP-FPM, with WP Super Cache. The cache is saved to the filesystem, allowing Nginx to serve static files (which it is <a href="http://nbonvin.wordpress.com/2011/03/14/apache-vs-nginx-vs-varnish-vs-gwan/">very good at</a>) without needing to pass any requests to PHP. This setup has worked very well, so I’ll be using it as a baseline.</p> <p>To use Memcached, every request needs to be passed to PHP. My gut feeling was that this would be slower than serving static files with Nginx due to the overhead of spinning up a PHP process for each request.</p> <h2 id="benchmarks">Benchmarks</h2> <p>To find out which of the two setups was faster, I measured the following metrics using <a href="http://www.webpagetest.org/">WebPagetest</a> and <a href="http://www.blitz.io/bhm0Fw2xDFNoGcFXNKJaQSu">Blitz</a> <small>(referral link)</small>:</p> <ul> <li>Time To First Byte (although CloudFlare has speculated that <a href="http://blog.cloudflare.com/ttfb-time-to-first-byte-considered-meaningles">TTFB is a meaningless metric</a>)</li> <li>Average response time</li> <li>Average hit rate</li> </ul> <!--more--> <h3 id="nginx--wpsc">Nginx + WPSC</h3> <div class="highlight"><pre><code>TTFB            0.244 seconds
Response Time   310 ms
Hit Rate        89 hits/second
</code></pre></div> <div class="thumbnail"> <a class="thumbnail__link" href="https://www.blitz.io/report/ecce61c2da008b383a5640d7f76593e7"> <img class="thumbnail__image" alt="Nginx + WPSC" src="/assets/nginx-wpsc.png" srcset="/assets/resized/nginx-wpsc-290x221.png 290w, /assets/resized/nginx-wpsc-315x240.png 315w, /assets/resized/nginx-wpsc-720x548.png 720w, /assets/resized/nginx-wpsc-940x715.png 940w, /assets/resized/nginx-wpsc-780x594.png 780w,  /assets/nginx-wpsc.png 950w"> </a> <div class="thumbnail__caption"> Nginx + WPSC </div> </div> <h3 id="nginx--php-fpm--memcached">Nginx + PHP-FPM + Memcached</h3> <div class="highlight"><pre><code>TTFB            0.126 seconds
Response Time   241 ms
Hit Rate        94 hits/second
</code></pre></div> <div class="thumbnail"> <a class="thumbnail__link" href="https://www.blitz.io/report/ecce61c2da008b383a5640d7f7857f5b"> <img class="thumbnail__image" alt="Nginx + PHP-FPM + Memcached" src="/assets/nginx-memcached.png" srcset="/assets/resized/nginx-memcached-290x221.png 290w, /assets/resized/nginx-memcached-315x240.png 315w, /assets/resized/nginx-memcached-720x548.png 720w, /assets/resized/nginx-memcached-940x715.png 940w, /assets/resized/nginx-memcached-780x594.png 780w,  /assets/nginx-memcached.png 950w"> </a> <div class="thumbnail__caption"> Nginx + PHP-FPM + Memcached </div> </div> <h2 id="conclusions">Conclusions</h2> <p>While the difference between the two setups isn’t huge, the Memcached setup still came out noticeably faster with nearly half the TTFB and a 70ms faster response time. It also managed to serve 5 hits/second more than the WPSC setup.</p> <h2 id="the-setup">The Setup</h2> <p>If you want to try out this setup for yourself, it’s relatively simple to get running.</p> <p>First you’ll need to create the PHP script that handles the caching. I’ve called mine <code>index-cached.php</code>. The script below will cache pages with the key <code>fullpage:your.domain.com/the/page/uri</code> for 1 day. It will also append a comment to the end of the response, specifying whether the page was served from cache or generated dynamically and how long the execution took.</p> <div class="highlight"><pre><code class="language-php"><span class="o">&lt;?</span><span class="nx">php</span>

<span class="nv">$start</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="nv">$memcached</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Memcached</span><span class="p">;</span>
<span class="nv">$memcached</span><span class="o">-&gt;</span><span class="na">addServer</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">11211</span><span class="p">);</span>

<span class="c1">// Cache time in seconds (1 day)</span>
<span class="nv">$cacheTime</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">1</span><span class="p">;</span>
<span class="nv">$cacheKey</span> <span class="o">=</span> <span class="s2">&quot;fullpage:</span><span class="si">{</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">]</span><span class="si">}{</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>

<span class="nv">$debugMessage</span> <span class="o">=</span> <span class="s1">&#39;Page retrieved from cache in %f seconds&#39;</span><span class="p">;</span>
<span class="nv">$html</span> <span class="o">=</span> <span class="nv">$memcached</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$cacheKey</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$html</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$debugMessage</span> <span class="o">=</span> <span class="s1">&#39;Page generated in %f seconds&#39;</span><span class="p">;</span>

    <span class="nb">ob_start</span><span class="p">();</span>

    <span class="k">require</span> <span class="s1">&#39;index.php&#39;</span><span class="p">;</span>
    <span class="nv">$html</span> <span class="o">=</span> <span class="nb">ob_get_contents</span><span class="p">();</span>

    <span class="nv">$memcached</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$cacheKey</span><span class="p">,</span> <span class="nv">$html</span><span class="p">,</span> <span class="nv">$cacheTime</span><span class="p">);</span>

    <span class="nb">ob_end_clean</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$finish</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>

<span class="k">echo</span> <span class="nv">$html</span><span class="p">;</span>
<span class="k">echo</span> <span class="s1">&#39;&lt;!-- &#39;</span> <span class="o">.</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nv">$debugMessage</span><span class="p">,</span> <span class="nv">$finish</span> <span class="o">-</span> <span class="nv">$start</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39; --&gt;&#39;</span><span class="p">;</span>
<span class="k">exit</span><span class="p">;</span></code></pre></div> <p>You also need to modify your Nginx site configuration to use this new script instead of the usual <code>index.php</code>. The configuration below is an example of how to do this. <strong>It is not a fully-working site configuration</strong>.</p> <p>The important things to notice are:</p> <ul> <li>If we determine that the current request can be cached, we set <code>index</code> to index-cached.php.</li> <li>The cache isn’t used if the request is from a mobile browser, if any login cookies are found, or if there are any query arguments.</li> <li>The cache isn’t used for the admin panel (/wp-admin).</li> </ul> <div class="highlight"><pre><code class="language-nginx"><span class="k">server</span> <span class="p">{</span>
    <span class="kn">server_name</span> <span class="s">yourdomain.com</span><span class="p">;</span>
    <span class="kn">root</span> <span class="s">/var/www/yourdomain</span><span class="p">;</span>
    <span class="kn">error_page</span> <span class="mi">404</span> <span class="p">=</span> <span class="s">/index.php</span><span class="p">;</span>

    <span class="kn">set</span> <span class="nv">$cache_flags</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="c1"># Is this a mobile browser?</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$http_user_agent</span> <span class="p">~</span><span class="sr">*</span> <span class="s">&quot;(2.0</span> <span class="s">MMP|240x320|400X240|AvantGo|BlackBerry|Blazer|Cellphone|Danger|DoCoMo|Elaine/3.0|EudoraWeb|Googlebot-Mobile|hiptop|IEMobile|KYOCERA/WX310K|LG/U990|MIDP-2.|MMEF20|MOT-V|NetFront|Newt|Nintendo</span> <span class="s">Wii|Nitro|Nokia|Opera</span> <span class="s">Mini|Palm|PlayStation</span> <span class="s">Portable|portalmmm|Proxinet|ProxiNet|SHARP-TQ-GX10|SHG-i900|Small|SonyEricsson|Symbian</span> <span class="s">OS|SymbianOS|TS21i-10|UP.Browser|UP.Link|webOS|Windows</span> <span class="s">CE|WinWAP|YahooSeeker/M1A1-R2D2|NF-Browser|iPhone|iPod|Mobile|BlackBerry9530|G-TU915</span> <span class="s">Obigo|LGE</span> <span class="s">VX|webOS|Nokia5800)&quot;</span> <span class="s">)</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$cache_flags</span> <span class="s">&quot;</span><span class="p">{</span><span class="kn">$cache_flags}M&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># Is the user logged in?</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$http_cookie</span> <span class="p">~</span><span class="sr">*</span> <span class="s">&quot;(comment_author_|wordpress_logged_in_|wp-postpass_)&quot;</span> <span class="s">)</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$cache_flags</span> <span class="s">&quot;</span><span class="nv">${cache_flags}C&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># Do we have query arguments?</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$is_args</span><span class="s">)</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$cache_flags</span> <span class="s">&quot;</span><span class="nv">${cache_flags}Q&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># If none of the rules above were matched, we can use the cache</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$cache_flags</span> <span class="p">=</span> <span class="s">&quot;&quot;)</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$index_file</span> <span class="s">/index-cached.php</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># Otherwise we&#39;ll just use index.php</span>
    <span class="kn">if</span> <span class="s">(</span><span class="nv">$cache_flags</span> <span class="s">!=</span> <span class="s">&quot;&quot;)</span> <span class="p">{</span>
        <span class="kn">set</span> <span class="nv">$index_file</span> <span class="s">/index.php</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">index</span> <span class="nv">$index_file</span> <span class="s">index.html</span><span class="p">;</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri/</span> <span class="nv">$index_file?$args</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># Force /wp-admin requests to always use index.php</span>
    <span class="kn">location</span> <span class="s">/wp-admin/</span> <span class="p">{</span>
        <span class="kn">index</span> <span class="s">index.php</span><span class="p">;</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri/</span> <span class="s">/index.php?</span><span class="nv">$args</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1"># Pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
    <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
        <span class="kn">include</span> <span class="s">fastcgi_params</span><span class="p">;</span>
        <span class="kn">fastcgi_split_path_info</span> <span class="s">^(.+\.php)(/.+)</span>$<span class="p">;</span>
        <span class="kn">fastcgi_pass</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div> <h2 id="future-plans">Future Plans</h2> <p>This setup is inherently flawed in that it won’t be able to stand up to a large traffic spike. This is because every single request needs to go through PHP-FPM. With enough traffic, PHP-FPM will eventually be unable to spawn enough processes to handle every request.</p> <p>The next step in caching would be to put a reverse-proxy like <a href="https://www.varnish-cache.org/">Varnish</a> in front of Nginx. This (in theory) should allow the server to handle massive spikes in traffic because none of the requests would have to go through PHP-FPM.</p> <p>Another option would be to use a content delivery network like <a href="https://www.cloudflare.com/">CloudFlare</a>, which would be able to offload the majority of traffic to the site.</p> <p><strong>Update: I’ve run the benchmarks with CloudFlare. Here are the results:</strong></p> <div class="highlight"><pre><code>TTFB            0.188 seconds
Response Time   131 ms
Hit Rate        101 hits/second
</code></pre></div> <div class="thumbnail"> <img class="thumbnail__image" alt="CloudFlare" src="/assets/cloudflare.png" srcset="/assets/resized/cloudflare-290x221.png 290w, /assets/resized/cloudflare-315x240.png 315w, /assets/resized/cloudflare-720x548.png 720w, /assets/resized/cloudflare-940x715.png 940w, /assets/resized/cloudflare-780x594.png 780w,  /assets/cloudflare.png 950w"> <div class="thumbnail__caption"> CloudFlare </div> </div> <p>The numbers seem impressive, but the graphs generated by Blitz show that the response times vary quite dramatically. I’ve also used CloudFlare in the past and found that the TTFB isn’t always as low as this. This is part of the reason I stopped using CloudFlare; while synthetic benchmarks make it look fast, I found that average load actually times went up …But that’s a story for another blog post.</p> </article> <footer class="post-meta post-meta--footer"> <p> This post was written by <strong>Joseph Wynn</strong> on <strong>20 May, 2013</strong>, and last updated on <strong>15 January, 2015</strong>. It was posted in <span class="post-meta__data"> [<a href="/category/server administration/">server administration</a>, <a href="/category/web development/">web development</a>] </span> and tagged with <span class="post-meta__data"> [<a href="/tag/memcached/">memcached</a>, <a href="/tag/nginx/">nginx</a>, <a href="/tag/php-fpm/">php-fpm</a>, <a href="/tag/wordpress/">wordpress</a>] </span> </p> </footer> <div class="post-comments" id="disqus_thread"></div> <script>var disqus_shortname = 'wildlyinaccurate';
    var disqus_url = 'https://wildlyinaccurate.com/blazing-fast-wordpress-with-nginx-and-memcached';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script> <footer class="page-footer"> <ul class="social-media"> <li> <a href="https://github.com/wildlyinaccurate"> <span class="social-media__icon"> <svg viewbox="0 0 16 16"> <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"> </svg> </span> <span class="username">wildlyinaccurate</span> </a> </li> <li> <a href="https://twitter.com/Joseph_Wynn"> <span class="social-media__icon"> <svg viewbox="0 0 16 16"> <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                        c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"> </svg> </span> <span class="username">Joseph_Wynn</span> </a> </li> </ul> <p class="site-description site-description--footer">A collection of guides &amp; opinions about programming and the state of the web, from a developer at BBC News. </p> </footer> <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-20744182-3', 'auto');
          ga('send', 'pageview');</script> <script>(function() {
                var s, p, n, a;

                s = document.createElement('script');
                s.async = 1;
                s.src = '//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=wildlyinaccuratecom';
                s.id = '_carbonads_js';

                p = document.createElement('p');
                p.appendChild(s);

                n = document.querySelector('.post-content > p:nth-of-type(3)');

                if (n) {
                    n.parentNode.insertBefore(p, n.nextSibling);
                } else {
                    n = document.getElementsByTagName('article')[0];
                    n.parentNode.insertBefore(p, n.nextSibling);
                }
            })();</script> </body> </html>