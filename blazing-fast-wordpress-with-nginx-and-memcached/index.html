<!DOCTYPE html>
<html lang="en">

    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width initial-scale=1">

    <title>Blazing fast WordPress with Nginx and Memcached | Wildly Inaccurate</title>
    <meta name="description" content="Inspired by Eric Mann’s post on caching WordPress with Redis, I thought I’d experiment with a similar setup using Memcached. Any in-memory caching system sho...">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto:300,700|Merriweather:300italic,300,700">
    <link rel="canonical" href="https://wildlyinaccurate.github.io/blazing-fast-wordpress-with-nginx-and-memcached">
    <link rel="alternate" type="application/atom+xml" title="Wildly Inaccurate" href="https://wildlyinaccurate.github.io/feed.xml">
</head>


    <body>

        <nav class="navbar">
    <div class="container">
        <a href="https://wildlyinaccurate.github.io" class="navbar__title navbar__link">Wildly Inaccurate</a>

        <ul class="navbar-nav">
        
            
            <li class="navbar-nav__item">
                <a class="navbar-nav__item-link navbar__link" href="/about/">About</a>
            </li>
            
        
            
        
            
        
            
        
            
            <li class="navbar-nav__item">
                <a class="navbar-nav__item-link navbar__link" href="/projects/">Projects</a>
            </li>
            
        
        </ul>
    </div>
</nav>


        <header class="page-header">
    
        
    

    <img class="page-header__featured-image" src="/assets/default-featured-image.jpg" srcset="/assets/resized/default-featured-image-290x145.jpg 290w, /assets/resized/default-featured-image-315x158.jpg 315w, /assets/resized/default-featured-image-720x360.jpg 720w, /assets/resized/default-featured-image-940x470.jpg 940w, /assets/resized/default-featured-image-1140x570.jpg 1140w, /assets/resized/default-featured-image-1280x640.jpg 1280w, /assets/resized/default-featured-image-1360x680.jpg 1360w, /assets/resized/default-featured-image-1680x840.jpg 1680w, /assets/resized/default-featured-image-1840x920.jpg 1840w,  /assets/default-featured-image.jpg 2600w">


    <div class="container">
        <h1 class="page-header__title">Blazing fast WordPress with Nginx and Memcached</h1>
        <p class="page-header__meta">
            May 20, 2013

            
                • by Joseph Wynn
            

            
        </p>
    </div>
</header>

<article class="post-content">
    <p>Inspired by Eric Mann’s post on <a href="http://eamann.com/tech/ludicrous-speed-wordpress-caching-with-redis/">caching WordPress with Redis</a>, I thought I’d experiment with a similar setup using Memcached. Any in-memory caching system should work just as well, but I’ve chosen Memcached because it’s already running on my server and because PHP already has a <a href="http://www.php.net/manual/en/class.memcached.php">built-in libmemcached API</a>.</p>

<p>My current setup is Nginx and PHP-FPM, with WP Super Cache. The cache is saved to the filesystem, allowing Nginx to serve static files (which it is <a href="http://nbonvin.wordpress.com/2011/03/14/apache-vs-nginx-vs-varnish-vs-gwan/">very good at</a>) without needing to pass any requests to PHP. This setup has worked very well, so I’ll be using it as a baseline.</p>

<p>To use Memcached, every request needs to be passed to PHP. My gut feeling was that this would be slower than serving static files with Nginx due to the overhead of spinning up a PHP process for each request.</p>

<h2 id="benchmarks">Benchmarks</h2>

<p>To find out which of the two setups was faster, I measured the following metrics using <a href="http://www.webpagetest.org/">WebPagetest</a> and <a href="http://www.blitz.io/bhm0Fw2xDFNoGcFXNKJaQSu">Blitz</a> <small>(referral link)</small>:</p>

<ul>
  <li>Time To First Byte (although CloudFlare has speculated that <a href="http://blog.cloudflare.com/ttfb-time-to-first-byte-considered-meaningles">TTFB is a meaningless metric</a>)</li>
  <li>Average response time</li>
  <li>Average hit rate</li>
</ul>

<!--more-->

<h3 id="nginx--wpsc">Nginx + WPSC</h3>

<pre><code>TTFB            0.244 seconds
Response Time   310 ms
Hit Rate        89 hits/second
</code></pre>

<p>[&lt;div class="thumbnail"&gt;<br />
    <img class="thumbnail__image" alt="Nginx + WPSC" src="/assets/nginx-wpsc.png" srcset="/assets/resized/nginx-wpsc-290x221.png 290w, /assets/resized/nginx-wpsc-315x240.png 315w, /assets/resized/nginx-wpsc-720x548.png 720w, /assets/resized/nginx-wpsc-940x715.png 940w,  /assets/nginx-wpsc.png 950w" /></p>

<pre><code>&lt;div class="thumbnail__caption"&gt;
    Nginx + WPSC
&lt;/div&gt;
</code></pre>

<p>&lt;/div&gt;<br />
](https://www.blitz.io/report/ecce61c2da008b383a5640d7f76593e7)</p>

<h3 id="nginx--php-fpm--memcached">Nginx + PHP-FPM + Memcached</h3>

<pre><code>TTFB            0.126 seconds
Response Time   241 ms
Hit Rate        94 hits/second
</code></pre>

<p>[&lt;div class="thumbnail"&gt;<br />
    <img class="thumbnail__image" alt="Nginx + PHP-FPM + Memcached" src="/assets/nginx-memcached.png" srcset="/assets/resized/nginx-memcached-290x221.png 290w, /assets/resized/nginx-memcached-315x240.png 315w, /assets/resized/nginx-memcached-720x548.png 720w, /assets/resized/nginx-memcached-940x715.png 940w,  /assets/nginx-memcached.png 950w" /></p>

<pre><code>&lt;div class="thumbnail__caption"&gt;
    Nginx + PHP-FPM + Memcached
&lt;/div&gt;
</code></pre>

<p>&lt;/div&gt;<br />
](https://www.blitz.io/report/ecce61c2da008b383a5640d7f7857f5b)</p>

<h2 id="conclusions">Conclusions</h2>

<p>While the difference between the two setups isn’t huge, the Memcached setup still came out noticeably faster with nearly half the TTFB and a 70ms faster response time. It also managed to serve 5 hits/second more than the WPSC setup.</p>

<h2 id="the-setup">The Setup</h2>

<p>If you want to try out this setup for yourself, it’s relatively simple to get running.</p>

<p>First you’ll need to create the PHP script that handles the caching. I’ve called mine <code>index-cached.php</code>. The script below will cache pages with the key <code>fullpage:your.domain.com/the/page/uri</code> for 1 day. It will also append a comment to the end of the response, specifying whether the page was served from cache or generated dynamically and how long the execution took.</p>

<pre><code class="language-php">&lt;?php

$start = microtime(true);

$memcached = new Memcached;
$memcached-&gt;addServer('127.0.0.1', 11211);

// Cache time in seconds (1 day)
$cacheTime = 60 * 60 * 24 * 1;
$cacheKey = "fullpage:{$_SERVER['HTTP_HOST']}{$_SERVER['REQUEST_URI']}";

$debugMessage = 'Page retrieved from cache in %f seconds';
$html = $memcached-&gt;get($cacheKey);

if ( ! $html) {
    $debugMessage = 'Page generated in %f seconds';

    ob_start();

    require 'index.php';
    $html = ob_get_contents();

    $memcached-&gt;set($cacheKey, $html, $cacheTime);

    ob_end_clean();
}

$finish = microtime(true);

echo $html;
echo '&lt;!-- ' . sprintf($debugMessage, $finish - $start) . ' --&gt;';
exit;
</code></pre>

<p>You also need to modify your Nginx site configuration to use this new script instead of the usual <code>index.php</code>. The configuration below is an example of how to do this. <strong>It is not a fully-working site configuration</strong>.</p>

<p>The important things to notice are:</p>

<ul>
  <li>If we determine that the current request can be cached, we set <code>index</code> to index-cached.php.</li>
  <li>The cache isn’t used if the request is from a mobile browser, if any login cookies are found, or if there are any query arguments.</li>
  <li>
    <p>The cache isn’t used for the admin panel (/wp-admin).<br />
```nginx<br />
server {<br />
server_name yourdomain.com;<br />
root /var/www/yourdomain;<br />
error_page 404 = /index.php;</p>

    <p>set $cache_flags “”;</p>

    <h1 id="is-this-a-mobile-browser">Is this a mobile browser?</h1>
    <p>if ($http_user_agent ~* “(2.0 MMP|240x320|400X240|AvantGo|BlackBerry|Blazer|Cellphone|Danger|DoCoMo|Elaine/3.0|EudoraWeb|Googlebot-Mobile|hiptop|IEMobile|KYOCERA/WX310K|LG/U990|MIDP-2.|MMEF20|MOT-V|NetFront|Newt|Nintendo Wii|Nitro|Nokia|Opera Mini|Palm|PlayStation Portable|portalmmm|Proxinet|ProxiNet|SHARP-TQ-GX10|SHG-i900|Small|SonyEricsson|Symbian OS|SymbianOS|TS21i-10|UP.Browser|UP.Link|webOS|Windows CE|WinWAP|YahooSeeker/M1A1-R2D2|NF-Browser|iPhone|iPod|Mobile|BlackBerry9530|G-TU915 Obigo|LGE VX|webOS|Nokia5800)” ) {<br />
    set $cache_flags “{$cache_flags}M”;<br />
}</p>

    <h1 id="is-the-user-logged-in">Is the user logged in?</h1>
    <p>if ($http_cookie ~* “(comment_author<em>|wordpress_logged_in</em>|wp-postpass_)” ) {<br />
    set $cache_flags “${cache_flags}C”;<br />
}</p>

    <h1 id="do-we-have-query-arguments">Do we have query arguments?</h1>
    <p>if ($is_args) {<br />
    set $cache_flags “${cache_flags}Q”;<br />
}</p>

    <h1 id="if-none-of-the-rules-above-were-matched-we-can-use-the-cache">If none of the rules above were matched, we can use the cache</h1>
    <p>if ($cache_flags = “”) {<br />
    set $index_file /index-cached.php;<br />
}</p>

    <h1 id="otherwise-well-just-use-indexphp">Otherwise we’ll just use index.php</h1>
    <p>if ($cache_flags != “”) {<br />
    set $index_file /index.php;<br />
}</p>

    <p>location / {<br />
    index $index_file index.html;<br />
    try_files $uri $uri/ $index_file?$args;<br />
}</p>

    <h1 id="force-wp-admin-requests-to-always-use-indexphp">Force /wp-admin requests to always use index.php</h1>
    <p>location /wp-admin/ {<br />
    index index.php;<br />
    try_files $uri $uri/ /index.php?$args;<br />
}</p>

    <h1 id="pass-the-php-scripts-to-fastcgi-server-listening-on-1270019000">Pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</h1>
    <p>location ~ .php$ {<br />
    try_files $uri =404;<br />
    include fastcgi_params;<br />
    fastcgi_split_path_info ^(.+.php)(/.+)$;<br />
    fastcgi_pass 127.0.0.1:9000;<br />
}<br />
}<br />
```</p>
  </li>
</ul>

<h2 id="future-plans">Future Plans</h2>

<p>This setup is inherently flawed in that it won’t be able to stand up to a large traffic spike. This is because every single request needs to go through PHP-FPM. With enough traffic, PHP-FPM will eventually be unable to spawn enough processes to handle every request.</p>

<p>The next step in caching would be to put a reverse-proxy like <a href="https://www.varnish-cache.org/">Varnish</a> in front of Nginx. This (in theory) should allow the server to handle massive spikes in traffic because none of the requests would have to go through PHP-FPM.</p>

<p>Another option would be to use a content delivery network like <a href="https://www.cloudflare.com/">CloudFlare</a>, which would be able to offload the majority of traffic to the site.</p>

<p><strong>Update: I’ve run the benchmarks with CloudFlare. Here are the results:</strong></p>

<pre><code>TTFB            0.188 seconds
Response Time   131 ms
Hit Rate        101 hits/second
</code></pre>

<p>[&lt;div class="thumbnail"&gt;<br />
    <img class="thumbnail__image" alt="CloudFlare" src="/assets/cloudflare.png" srcset="/assets/resized/cloudflare-290x221.png 290w, /assets/resized/cloudflare-315x240.png 315w, /assets/resized/cloudflare-720x548.png 720w, /assets/resized/cloudflare-940x715.png 940w,  /assets/cloudflare.png 950w" /></p>

<pre><code>&lt;div class="thumbnail__caption"&gt;
    CloudFlare
&lt;/div&gt;
</code></pre>

<p>&lt;/div&gt;</p>

<p>The numbers seem impressive, but the graphs generated by Blitz show that the response times vary quite dramatically. I’ve also used CloudFlare in the past and found that the TTFB isn’t always as low as this. This is part of the reason I stopped using CloudFlare; while synthetic benchmarks make it look fast, I found that average load actually times went up …But that’s a story for another blog post.</p>

</article>


        <footer class="page-footer">

    <ul class="social-media">
        
        <li>
            <a href="https://github.com/wildlyinaccurate">
                <span class="social-media__icon">
                    <svg viewBox="0 0 16 16">
                        <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                    </svg>
                </span>
                <span class="username">wildlyinaccurate</span>
            </a>
        </li>
        

        
        <li>
            <a href="https://twitter.com/Joseph_Wynn">
                <span class="social-media__icon">
                    <svg viewBox="0 0 16 16">
                        <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                        c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                    </svg>
                </span>

                <span class="username">Joseph_Wynn</span>
            </a>
        </li>
        
    </ul>

    <p class="site-description">Guides &amp; opinions about programming and the state of the web.
</p>

</footer>


    </body>

</html>
